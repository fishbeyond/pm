<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:int="http://www.springframework.org/schema/integration"
       xmlns:int-http="http://www.springframework.org/schema/integration/http"
       xmlns:int-jdbc="http://www.springframework.org/schema/integration/jdbc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                  http://www.springframework.org/schema/beans/spring-beans.xsd
                  http://www.springframework.org/schema/integration
                  http://www.springframework.org/schema/integration/spring-integration.xsd
                  http://www.springframework.org/schema/integration/http
                  http://www.springframework.org/schema/integration/http/spring-integration-http.xsd
                  http://www.springframework.org/schema/integration/jdbc
                  http://www.springframework.org/schema/integration/jdbc/spring-integration-jdbc.xsd">

    <int:chain input-channel="projectService.findProjectByUserId">
        <int-jdbc:outbound-gateway data-source="dataSource" max-rows-per-poll="0"
                                   query="select * from project where projectId in (select projectId from crew where userId=:payload[userId])">
            <int-jdbc:request-handler-advice-chain>
                <bean class="com.hs.pm.transform.NullReplyAdvice"/>
            </int-jdbc:request-handler-advice-chain>
        </int-jdbc:outbound-gateway>
    </int:chain>
    <int:chain input-channel="projectService.createProject">
        <int-jdbc:stored-proc-outbound-gateway data-source="dataSource"
                                               stored-procedure-name="create_project">
            <int-jdbc:parameter name="project_name" expression="payload[projectName][0]"/>
            <int-jdbc:parameter name="content" expression="payload[content][0]"/>
            <int-jdbc:parameter name="create_time" expression="headers[nowDate]"/>
            <int-jdbc:parameter name="create_user_id" expression="payload[createUserId][0]"/>
            <int-jdbc:request-handler-advice-chain>
                <bean class="com.hs.pm.transform.NullReplyAdvice"/>
            </int-jdbc:request-handler-advice-chain>
        </int-jdbc:stored-proc-outbound-gateway>
    </int:chain>
    <int:chain input-channel="projectService.deleteProject">
        <int-jdbc:stored-proc-outbound-gateway data-source="dataSource"
                                               stored-procedure-name="delete_project">
            <int-jdbc:parameter name="project_id" expression="payload[projectId][0]"/>
            <int-jdbc:request-handler-advice-chain>
                <bean class="com.hs.pm.transform.NullReplyAdvice"/>
            </int-jdbc:request-handler-advice-chain>
        </int-jdbc:stored-proc-outbound-gateway>
    </int:chain>
    <int:chain input-channel="projectService.updateProject">
        <int-jdbc:stored-proc-outbound-gateway data-source="dataSource"
                                               stored-procedure-name="update_project">
            <int-jdbc:parameter name="create_time" expression="headers[nowDate]"/>
            <int-jdbc:parameter name="project_name" expression="payload[projectName][0]"/>
            <int-jdbc:parameter name="content" expression="payload[content][0]"/>
            <int-jdbc:parameter name="project_id" expression="payload[projectId][0]"/>
            <int-jdbc:parameter name="create_user_id" expression="payload[createUserId][0]"/>
            <int-jdbc:request-handler-advice-chain>
                <bean class="com.hs.pm.transform.NullReplyAdvice"/>
            </int-jdbc:request-handler-advice-chain>
        </int-jdbc:stored-proc-outbound-gateway>
    </int:chain>
    <int:chain input-channel="projectService.addMember">
        <int-jdbc:stored-proc-outbound-gateway data-source="dataSource"
                                               stored-procedure-name="project_add_member">
            <int-jdbc:parameter name="operate_time" expression="headers[nowDate]"/>
            <int-jdbc:parameter name="operator_id" expression="payload[operatorId][0]"/>
            <int-jdbc:parameter name="project_id" expression="payload[projectId][0]"/>
            <int-jdbc:parameter name="phone_no" expression="payload[phoneNo][0]"/>
            <int-jdbc:parameter name="mail_address" expression="payload[mailAddress][0]"/>
            <int-jdbc:parameter name="user_name" expression="payload[userName][0]"/>
            <int-jdbc:request-handler-advice-chain>
                <bean class="com.hs.pm.transform.NullReplyAdvice"/>
            </int-jdbc:request-handler-advice-chain>
        </int-jdbc:stored-proc-outbound-gateway>
    </int:chain>

    <int:gateway service-interface="com.hs.pm.projectDetail.ProjectDetailService">
        <int:method name="save" request-channel="saveProjectDetail"/>
    </int:gateway>
    <int:chain input-channel="saveProjectDetail">
        <int-jdbc:outbound-gateway data-source="dataSource"
                                   update="insert into project_detail (detail,operateTime,projectId) values (:payload[detail],:headers[nowDate],:payload[projectId])">
        </int-jdbc:outbound-gateway>
    </int:chain>
</beans>